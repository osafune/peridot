// ***************************************************************************** //
// PERIDOT Chrome Apps driver - 'Canarium' (version 0.9.8)                       //
// Copyright (C) 2016 @kimu_shu and @s_osafune                                   //
// ----------------------------------------------------------------------------- //
// Additional part of Canarium (since version 0.9.7) is distributed under the    //
// following license:                                                            //
//                                                                               //
// The MIT License (MIT)                                                         //
//                                                                               //
// Copyright (c) 2016 Shuta Kimura (@kimu_shu)                                   //
//                                                                               //
// Permission is hereby granted, free of charge, to any person obtaining a copy  //
// of this software and associated documentation files (the "Software"), to deal //
// in the Software without restriction, including without limitation the rights  //
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell     //
// copies of the Software, and to permit persons to whom the Software is         //
// furnished to do so, subject to the following conditions:                      //
//                                                                               //
// The above copyright notice and this permission notice shall be included in    //
// all copies or substantial portions of the Software.                           //
//                                                                               //
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR    //
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,      //
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE   //
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER        //
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, //
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN     //
// THE SOFTWARE.                                                                 //
// ----------------------------------------------------------------------------- //
// The original version of Canarium (below version 0.9.6) is written by          //
// @s_osafune and distributed under the following license:                       //
//                                                                               //
//     Copyright (C) 2014, J-7SYSTEM Works.  All rights Reserved.                //
//                                                                               //
// * This module is a free sourcecode and there is NO WARRANTY.                  //
// * No restriction on use. You can use, modify and redistribute it for          //
//   personal, non-profit or commercial products UNDER YOUR RESPONSIBILITY.      //
// * Redistributions of source code must retain the above copyright notice.      //
//                                                                               //
//         PERIDOT Project - https://github.com/osafune/peridot                  //
// ***************************************************************************** //
(function(){var Canarium,IS_CHROME,IS_NODEJS,Promise,TimeLimit,finallyPromise,getCurrentTime,hexDump,invokeCallback,oldProperty,tryPromise,waitPromise;if(false){Uint8Array.prototype.hexDump=function(){return hexDump(this)}}IS_CHROME=(typeof chrome!=="undefined"&&chrome!==null?chrome.runtime:void 0)!=null;IS_NODEJS=!IS_CHROME&&(typeof process!=="undefined"&&process!==null)&&(typeof require!=="undefined"&&require!==null);if(IS_CHROME){Promise=window.Promise}else if(IS_NODEJS){Promise=require("es6-promise").Promise}oldProperty=Function.prototype.property;Function.prototype.property=function(prop,desc){return Object.defineProperty(this.prototype,prop,desc)};hexDump=function(data,maxBytes){var brace,hex,i,len,r;brace=true;if(typeof data==="number"){brace=false;data=[data]}else if(data instanceof ArrayBuffer){data=new Uint8Array(data)}else if(data instanceof Uint8Array){null}else if(data instanceof Array){null}else{throw Error("Unsupported data type: "+data)}len=data.length;if(maxBytes!=null){len=Math.min(len,maxBytes)}hex=function(v){return"0x"+(v<16?"0":"")+((v!=null?typeof v.toString==="function"?v.toString(16):void 0:void 0)||"??")};r=function(){var j,ref,results;results=[];for(i=j=0,ref=len;0<=ref?j<ref:j>ref;i=0<=ref?++j:--j){results.push(hex(data[i]))}return results}().join(",");if(data.length>len){r+="..."}if(brace){r="["+r+"]"}return r};invokeCallback=function(callback,promise){if(!callback){return promise}promise.then(function(value){callback(true,value)})["catch"](function(reason){callback(false,reason)})};waitPromise=function(dulation,value){return new Promise(function(resolve){return setTimeout(function(){return resolve(value)},dulation)})};tryPromise=function(timeout,promiser,maxTries){var count;count=0;return new Promise(function(resolve,reject){var lastReason,next;lastReason=void 0;next=function(){return promiser().then(function(value){return resolve(value)},function(reason){lastReason=reason;count++;if(maxTries!=null&&count>=maxTries){return reject(lastReason)}return setTimeout(function(){return typeof next==="function"?next():void 0},0)})};setTimeout(function(){next=null;return reject(lastReason||Error("Operation timed out after "+count+" tries"))},timeout);return next()})};finallyPromise=function(action){return[function(value){action();return value},function(error){action();return Promise.reject(error)}]};getCurrentTime=IS_CHROME?function(){return window.performance.now()}:IS_NODEJS?function(){var t;t=process.hrtime();return Math.round(t[0]*1e6+t[1]/1e3)/1e3}:void 0;TimeLimit=function(){function TimeLimit(timeout1){this.timeout=timeout1;this.start=this.now;return}TimeLimit.property("now",{get:getCurrentTime});TimeLimit.property("left",{get:function(){return Math.max(0,this.timeout-parseInt(this.now-this.start))}});return TimeLimit}();Canarium=function(){var AVM_CHANNEL,CONFIG_TIMEOUT_MS,EEPROM_SLAVE_ADDR,SPLIT_EEPROM_BURST;null;Canarium.property("version",{value:"0.9.8"});Canarium.property("boardInfo",{get:function(){return this._boardInfo}});Canarium.property("serialBitrate",{get:function(){return this._base.bitrate},set:function(v){return this._base.bitrate=v}});Canarium.property("connected",{get:function(){return this._base.connected}});Canarium.property("channels",{get:function(){return this._channels}});Canarium.property("i2c",{get:function(){return this._i2c}});Canarium.property("avs",{get:function(){return this._avs}});Canarium.property("avm",{get:function(){return this._avm}});Canarium.property("onClosed",{get:function(){return this._base.onClosed},set:function(v){return this._base.onClosed=v}});Canarium.verbosity=0;EEPROM_SLAVE_ADDR=80;SPLIT_EEPROM_BURST=6;CONFIG_TIMEOUT_MS=3e3;AVM_CHANNEL=0;Canarium.enumerate=function(callback){if(callback!=null){return invokeCallback(callback,this.enumerate())}return Canarium.BaseComm.enumerate()};function Canarium(){this._boardInfo=null;this._channels=null;this._base=new Canarium.BaseComm;this._i2c=new Canarium.I2CComm(this._base);this._avs=new Canarium.AvsPackets(this._base);this._avm=new Canarium.AvmTransactions(this._avs,AVM_CHANNEL);this._configBarrier=false;this._resetBarrier=false;return}Canarium.prototype.open=function(portname,callback){if(callback!=null){return invokeCallback(callback,this.open(portname))}return Promise.resolve().then(function(_this){return function(){return _this._base.connect(portname)}}(this)).then(function(_this){return function(){return Promise.resolve().then(function(){_this._boardInfo=null;return _this._eepromRead(0,4)}).then(function(readData){var header;header=new Uint8Array(readData);if(!(header[0]===74&&header[1]===55&&header[2]===87)){return Promise.reject(Error("EEPROM header is invalid"))}_this._log(1,"open","done(version="+hexDump(header[3])+")");_this._boardInfo={version:header[3]};return _this._base.transCommand(57)}).then(function(response){return _this._base.option({forceConfigured:(response&1)!==0})}).then(function(){})["catch"](function(error){return _this._base.disconnect()["catch"](function(){}).then(function(){return Promise.reject(error)})})}}(this))};Canarium.prototype.close=function(callback){if(callback!=null){return invokeCallback(callback,this.close())}return Promise.resolve().then(function(_this){return function(){return _this._base.disconnect()}}(this)).then(function(_this){return function(){_this._boardInfo=null}}(this))};Canarium.prototype.config=function(boardInfo,rbfdata,callback){var ref,timeLimit;if(callback!=null){return invokeCallback(callback,this.config(boardInfo,rbfdata))}if(this._configBarrier){return Promise.reject(Error("Configuration is now in progress"))}this._configBarrier=true;timeLimit=void 0;return(ref=Promise.resolve().then(function(_this){return function(){return _this._base.assertConnection()}}(this)).then(function(_this){return function(){var ref1,ref2;if(!boardInfo||((ref1=_this.boardInfo)!=null?ref1.id:void 0)&&((ref2=_this.boardInfo)!=null?ref2.serialcode:void 0)){return}return _this.getinfo()}}(this)).then(function(_this){return function(){var mismatch;mismatch=function(a,b){return a&&a!==b};if(mismatch(boardInfo!=null?boardInfo.id:void 0,_this.boardInfo.id)){return Promise.reject(Error("Board ID mismatch"))}if(mismatch(boardInfo!=null?boardInfo.serialcode:void 0,_this.boardInfo.serialcode)){return Promise.reject(Error("Board serial code mismatch"))}}}(this)).then(function(_this){return function(){return _this._base.transCommand(59)}}(this)).then(function(_this){return function(response){if((response&1)!==0){return Promise.reject(Error("Not PS mode"))}}}(this)).then(function(_this){return function(){return timeLimit=new TimeLimit(CONFIG_TIMEOUT_MS)}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._base.transCommand(50).then(function(response){if((response&6)!==0){return Promise.reject()}})})}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._base.transCommand(51).then(function(response){if((response&6)!==2){return Promise.reject()}})})}}(this)).then(function(_this){return function(){return _this._base.transData(rbfdata)}}(this)).then(function(_this){return function(){return _this._base.transCommand(51)}}(this)).then(function(_this){return function(response){if((response&6)!==6){return Promise.reject(Error("FPGA configuration failed"))}}}(this)).then(function(_this){return function(){return _this._base.transCommand(57)}}(this)).then(function(_this){return function(){return _this._base.option({forceConfigured:true})}}(this)).then(function(_this){return function(){}}(this))).then.apply(ref,finallyPromise(function(_this){return function(){return _this._configBarrier=false}}(this)))};Canarium.prototype.reset=function(callback){var ref;if(callback!=null){return invokeCallback(callback,this.reset())}if(this._resetBarrier){return Promise.reject(Error("Reset is now in progress"))}this._resetBarrier=true;return(ref=Promise.resolve().then(function(_this){return function(){return _this._base.transCommand(49)}}(this)).then(function(_this){return function(){return waitPromise(100)}}(this)).then(function(_this){return function(){return _this._base.transCommand(57)}}(this)).then(function(_this){return function(response){return response}}(this))).then.apply(ref,finallyPromise(function(_this){return function(){return _this._resetBarrier=false}}(this)))};Canarium.prototype.getinfo=function(callback){if(callback!=null){return invokeCallback(callback,this.getinfo())}return Promise.resolve().then(function(_this){return function(){return _this._base.assertConnection()}}(this)).then(function(_this){return function(){var ref;switch((ref=_this._boardInfo)!=null?ref.version:void 0){case void 0:return Promise.reject(Error("Boardinfo not loaded"));case 1:return _this._eepromRead(4,8).then(function(readData){var info,mid,pid,s,sid;info=new Uint8Array(readData);_this._log(1,"getinfo","ver1",info);mid=info[0]<<8|info[1]<<0;pid=info[2]<<8|info[3]<<0;sid=info[4]<<24|info[5]<<16|info[6]<<8|info[7]<<0;if(mid===114){s=""+pid.hex(4)+sid.hex(8);_this._boardInfo.id="J72A";return _this._boardInfo.serialcode=s.substr(0,6)+"-"+s.substr(6,6)+"-000000"}});case 2:return _this._eepromRead(4,22).then(function(readData){var bid,i,info,j,l,s;info=new Uint8Array(readData);_this._log(1,"getinfo","ver2",info);bid="";for(i=j=0;j<4;i=++j){bid+=String.fromCharCode(info[i])}s="";for(i=l=4;l<22;i=++l){s+=String.fromCharCode(info[i])}_this._boardInfo.id=""+bid;return _this._boardInfo.serialcode=s.substr(0,6)+"-"+s.substr(6,6)+"-"+s.substr(12,6)});default:return Promise.reject(Error("Unknown boardinfo version"))}}}(this)).then(function(_this){return function(){return _this.boardInfo}}(this))};Canarium.prototype._eepromRead=function(startaddr,readbytes){var array,lastError,x;array=new Uint8Array(readbytes);if(SPLIT_EEPROM_BURST!=null&&readbytes>SPLIT_EEPROM_BURST){return function(){var j,ref,ref1,results;results=[];for(x=j=0,ref=readbytes,ref1=SPLIT_EEPROM_BURST;ref1>0?j<ref:j>ref;x=j+=ref1){results.push(x)}return results}().reduce(function(_this){return function(sequence,offset){return sequence.then(function(){return _this._eepromRead(startaddr+offset,Math.min(SPLIT_EEPROM_BURST,readbytes-offset))}).then(function(partialData){array.set(new Uint8Array(partialData),offset)})}}(this),Promise.resolve()).then(function(_this){return function(){return array.buffer}}(this))}lastError=null;return Promise.resolve().then(function(_this){return function(){_this._log(1,"_eepromRead","begin(addr="+hexDump(startaddr)+",bytes="+hexDump(readbytes)+")");return _this.i2c.start()}}(this)).then(function(_this){return function(){return _this.i2c.write(EEPROM_SLAVE_ADDR<<1).then(function(ack){if(!ack){return Promise.reject(Error("EEPROM is not found."))}})}}(this)).then(function(_this){return function(){return _this.i2c.write(startaddr&255).then(function(ack){if(!ack){return Promise.reject(Error("Cannot write address in EEPROM"))}})}}(this)).then(function(_this){return function(){return _this.i2c.start()}}(this)).then(function(_this){return function(){return _this.i2c.write((EEPROM_SLAVE_ADDR<<1)+1).then(function(ack){if(!ack){return Promise.reject(Error("EEPROM is not found."))}})}}(this)).then(function(_this){return function(){var j,lastIndex,results;lastIndex=readbytes-1;return function(){results=[];for(var j=0;0<=lastIndex?j<=lastIndex:j>=lastIndex;0<=lastIndex?j++:j--){results.push(j)}return results}.apply(this).reduce(function(promise,index){return promise.then(function(){return _this.i2c.read(index!==lastIndex)}).then(function(byte){return array[index]=byte})},Promise.resolve())}}(this))["catch"](function(_this){return function(error){lastError=error}}(this)).then(function(_this){return function(){return _this.i2c.stop()}}(this)).then(function(_this){return function(){if(lastError){return Promise.reject(lastError)}_this._log(1,"_eepromRead","end",array);return array.buffer}}(this))};Canarium._log=function(cls,func,msg,data){var obj,out,time;if(typeof SUPPRESS_ALL_LOGS!=="undefined"&&SUPPRESS_ALL_LOGS!==null&&SUPPRESS_ALL_LOGS){return}time=getCurrentTime().toFixed(3);out=(obj={time:time},obj[cls+"#"+func]=msg,obj.stack=(new Error).stack.split("\n    ").slice(1),obj);if(data){out.data=data}console.log(out)};Canarium.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("Canarium",func,msg,data)}};return Canarium}();Canarium.BaseComm=function(){var SERIAL_TX_MAX_LENGTH,SUCCESSIVE_TX_WAIT_MS;null;BaseComm.property("connected",{get:function(){return this._connection!=null}});BaseComm.property("path",{get:function(){return""+this._path}});BaseComm.property("bitrate",{get:function(){return this._bitrate},set:function(v){return this._bitrate=parseInt(v)}});BaseComm.property("sendImmediate",{get:function(){return this._sendImmediate}});BaseComm.property("configured",{get:function(){return this._configured}});BaseComm.property("onClosed",{get:function(){return this._onClosed},set:function(v){return this._onClosed=v}});BaseComm.verbosity=0;SERIAL_TX_MAX_LENGTH=1024;SUCCESSIVE_TX_WAIT_MS=null;BaseComm.enumerate=function(){var getFriendlyName;getFriendlyName=function(port){var name,path;name=port.manufacturer;path=port.path;if(name&&name!==""){return name+" ("+path+")"}return""+path};return BaseComm.SerialWrapper.list().then(function(ports){var devices,j,len1,port;devices=[];for(j=0,len1=ports.length;j<len1;j++){port=ports[j];devices.push({path:""+port.path,name:getFriendlyName(port)})}return devices})};function BaseComm(){this._connection=null;this._bitrate=115200;this._sendImmediate=false;this._configured=false;return}BaseComm.prototype.connect=function(path){if(this._connection!=null){return Promise.reject(Error("Already connected"))}this._connection=new BaseComm.SerialWrapper(path,{baudRate:this._bitrate});this._receiver=null;return this._connection.open().then(function(_this){return function(){_this._connection.onClosed=function(){var base;_this._connection=null;if(typeof(base=_this._onClosed)==="function"){base()}};_this._connection.onReceived=function(data){if(typeof _this._receiver==="function"){_this._receiver(data)}}}}(this))["catch"](function(_this){return function(error){_this._connection=null;_this._receiver=null;return Promise.reject(error)}}(this))};BaseComm.prototype.option=function(option){if(this._connection==null){return Promise.reject(Error("Not connected"))}return Promise.resolve().then(function(_this){return function(){var value;if((value=option.fastAcknowledge)==null){return}_this._sendImmediate=!!value;return _this.transCommand(57|(value?2:0))}}(this)).then(function(_this){return function(){var value;if((value=option.forceConfigured)==null){return}_this._configured=!!value}}(this)).then(function(_this){return function(){}}(this))};BaseComm.prototype.disconnect=function(){return this.assertConnection().then(function(_this){return function(){_this._receiver=null;return _this._connection.close()}}(this))};BaseComm.prototype.assertConnection=function(){if(this._connection==null){return Promise.reject(Error("Not connected"))}return Promise.resolve()};BaseComm.prototype.transCommand=function(command){var txarray;txarray=new Uint8Array(2);txarray[0]=58;txarray[1]=command;return this._transSerial(txarray.buffer,function(_this){return function(rxdata){if(!(rxdata.byteLength>=1)){return}return 1}}(this)).then(function(_this){return function(rxdata){return new Uint8Array(rxdata)[0]}}(this))};BaseComm.prototype.transData=function(txdata,estimator){var byte,dst,j,len,len1,src;if(txdata){src=new Uint8Array(txdata);dst=new Uint8Array(txdata.byteLength*2);len=0;for(j=0,len1=src.length;j<len1;j++){byte=src[j];if(byte===58||byte===61){dst[len]=61;len+=1;byte^=32}dst[len]=byte;len+=1}txdata=dst.buffer.slice(0,len)}return this._transSerial(txdata,estimator)};BaseComm.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("BaseComm",func,msg,data)}};BaseComm.prototype._transSerial=function(txdata,estimator){var promise,txsize,x;if(this._connection==null){return Promise.reject(Error("Not connected"))}if(this._receiver!=null){return Promise.reject(Error("Operation is in progress"))}promise=new Promise(function(_this){return function(resolve,reject){return _this._receiver=function(rxdata,error){var newArray,offset,ref,result;if(rxdata!=null){offset=((ref=_this._rxBuffer)!=null?ref.byteLength:void 0)||0;newArray=new Uint8Array(offset+rxdata.byteLength);if(_this._rxBuffer!=null){newArray.set(new Uint8Array(_this._rxBuffer))}newArray.set(new Uint8Array(rxdata),offset);_this._rxBuffer=newArray.buffer;result=estimator(_this._rxBuffer,offset)}else{result=error}if(result instanceof Error){_this._rxBuffer=null;_this._receiver=null;return reject(result)}if(result!=null){rxdata=_this._rxBuffer.slice(0,result);_this._rxBuffer=_this._rxBuffer.slice(result);_this._receiver=null;return resolve(rxdata)}}}}(this));txsize=(txdata!=null?txdata.byteLength:void 0)||0;return function(){var j,ref,ref1,results;results=[];for(x=j=0,ref=txsize,ref1=SERIAL_TX_MAX_LENGTH;ref1>0?j<ref:j>ref;x=j+=ref1){results.push(x)}return results}().reduce(function(_this){return function(sequence,pos){return sequence.then(function(){var data,size;data=txdata.slice(pos,pos+SERIAL_TX_MAX_LENGTH);size=data.byteLength;return _this._connection.write(data).then(function(){return _this._log(1,"_transSerial","sent",new Uint8Array(data))}).then(function(){if(!(SUCCESSIVE_TX_WAIT_MS>0)){return}return waitPromise(SUCCESSIVE_TX_WAIT_MS)})})}}(this),Promise.resolve()).then(function(_this){return function(){if(estimator==null){_this._receiver=null;return new ArrayBuffer(0)}_this._log(1,"_transSerial","wait",promise);return promise}}(this))};return BaseComm}();Canarium.BaseComm.SerialWrapper=function(){var cidMap,nodeModule;null;if(IS_NODEJS){nodeModule=require("serialport")}if(IS_CHROME){cidMap={}}SerialWrapper.list=IS_CHROME?function(){return new Promise(function(_this){return function(resolve,reject){return chrome.serial.getDevices(function(ports){var port;return resolve(function(){var j,len1,results;results=[];for(j=0,len1=ports.length;j<len1;j++){port=ports[j];results.push({path:""+port.path,manufacturer:""+port.displayName,serialNumber:void 0,vendorId:""+port.vendorId,productId:""+port.productId})}return results}())})}}(this))}:IS_NODEJS?function(){return new Promise(function(_this){return function(resolve,reject){return nodeModule.list(function(error,ports){var port;if(error!=null){return reject(Error(error))}return resolve(function(){var j,len1,results;results=[];for(j=0,len1=ports.length;j<len1;j++){port=ports[j];if(port.pnpId!=null){results.push({path:""+port.comName,manufacturer:""+port.manufacturer,serialNumber:""+port.serialNumber,vendorId:""+port.vendorId,productId:""+port.productId})}}return results}())})}}(this))}:void 0;function SerialWrapper(_path,_options){var base,base1,base2;this._path=_path;this._options=_options;this._options||(this._options={});(base=this._options).baudRate||(base.baudRate=115200);(base1=this._options).dataBits||(base1.dataBits=8);(base2=this._options).stopBits||(base2.stopBits=1);this.onClosed=void 0;this.onReceived=void 0;return}SerialWrapper.prototype.open=IS_CHROME?function(){return new Promise(function(_this){return function(resolve,reject){var opts;opts={bitrate:_this._options.baudRate,receiveTimeout:500};return chrome.serial.connect(_this._path,opts,function(connectionInfo){if(connectionInfo==null){return reject(Error(chrome.runtime.lastError.message))}_this._cid=connectionInfo.connectionId;cidMap[_this._cid]=_this;return resolve()})}}(this))}:IS_NODEJS?function(){return new Promise(function(_this){return function(resolve,reject){var k,opts,ref,v;if(_this._sp==null){opts={dataCallback:function(data){return _this._dataHandler(data)},disconnectedCallback:function(){return _this._closeHandler()}};ref=_this._options;for(k in ref){v=ref[k];opts[k]=v}_this._sp=new nodeModule.SerialPort(_this._path,opts,false,function(){})}return _this._sp.open(function(error){if(error!=null){return reject(Error(error))}return resolve()})}}(this))}:void 0;SerialWrapper.prototype.write=IS_CHROME?function(data){return new Promise(function(_this){return function(resolve,reject){if(_this._cid==null){return reject(Error("disconnected"))}return chrome.serial.send(_this._cid,data,function(sendInfo){if(sendInfo.error!=null){return reject(Error(sendInfo.error))}if(sendInfo.bytesSent<data.byteLength){return reject(Error("pending"))}return resolve()})}}(this))}:IS_NODEJS?function(data){return new Promise(function(_this){return function(resolve,reject){if(_this._sp==null){return reject(Error("disconnected"))}return _this._sp.write(new Buffer(new Uint8Array(data)),function(error){if(error!=null){return reject(error)}return resolve()})}}(this))}:void 0;SerialWrapper.prototype.pause=IS_CHROME?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._cid==null){return reject(Error("disconnected"))}return chrome.serial.setPaused(_this._cid,true,function(){return resolve()})}}(this))}:IS_NODEJS?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._sp==null){return reject(Error("disconnected"))}_this._sp.pause();return resolve()}}(this))}:void 0;SerialWrapper.prototype.resume=IS_CHROME?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._cid==null){return reject(Error("disconnected"))}return chrome.serial.setPaused(_this._cid,false,function(){return resolve()})}}(this))}:IS_NODEJS?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._sp==null){return reject(Error("disconnected"))}_this._sp.resume();return resolve()}}(this))}:void 0;SerialWrapper.prototype.flush=IS_CHROME?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._cid==null){return reject(Error("disconnected"))}return chrome.serial.flush(_this._cid,function(result){if(!result){return reject(Error("unknown_error"))}return resolve()})}}(this))}:IS_NODEJS?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._sp==null){return reject(Error("disconnected"))}return _this._sp.flush(function(error){if(error!=null){return reject(error)}return resolve()})}}(this))}:void 0;SerialWrapper.prototype.drain=IS_CHROME?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._cid==null){return reject(Error("disconnected"))}return resolve()}}(this))}:IS_NODEJS?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._sp==null){return reject(Error("disconnected"))}return _this._sp.drain(function(error){if(error!=null){return reject(error)}return resolve()})}}(this))}:void 0;SerialWrapper.prototype.close=IS_CHROME?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._cid==null){return reject(Error("disconnected"))}return chrome.serial.disconnect(_this._cid,function(result){var base;if(!result){return reject(Error("unknown_error"))}delete cidMap[_this._cid];_this._cid=null;if(typeof(base=_this.onClosed)==="function"){base()}return resolve()})}}(this))}:IS_NODEJS?function(){return new Promise(function(_this){return function(resolve,reject){if(_this._sp==null){return reject(Error("disconnected"))}return _this._sp.close(function(error){var base;if(error!=null){return reject(error)}_this._sp.fd=void 0;_this._sp=null;if(typeof(base=_this.onClosed)==="function"){base()}return resolve()})}}(this))}:void 0;SerialWrapper.prototype._dataHandler=IS_NODEJS?function(data){var base;if(typeof(base=this.onReceived)==="function"){base(new Uint8Array(data).buffer)}}:void 0;SerialWrapper.prototype._closeHandler=IS_NODEJS?function(){this.close()["catch"](function(_this){return function(){}}(this))}:void 0;SerialWrapper._receiveHandler=IS_CHROME?function(info){var base,self;self=cidMap[info.connectionId];if(self==null){return}if(typeof(base=self.onReceived)==="function"){base(info.data)}}:void 0;SerialWrapper._receiveErrorHandler=IS_CHROME?function(info){var self;self=cidMap[info.connectionId];if(self==null){return}switch(info.error){case"timeout":null;break;case"disconnected":case"device_lost":case"break":case"frame_error":self.close()}}:void 0;if(IS_CHROME){chrome.serial.onReceive.addListener(SerialWrapper._receiveHandler)}if(IS_CHROME){chrome.serial.onReceiveError.addListener(SerialWrapper._receiveErrorHandler)}return SerialWrapper}();Canarium.I2CComm=function(){var I2C_TIMEOUT_MS;null;I2CComm.verbosity=0;I2C_TIMEOUT_MS=1e3;function I2CComm(_base){this._base=_base;return}I2CComm.prototype.start=function(callback){var timeLimit;if(callback!=null){return invokeCallback(callback,this.start())}timeLimit=void 0;return Promise.resolve().then(function(_this){return function(){_this._log(1,"start","(start condition)");timeLimit=new TimeLimit(I2C_TIMEOUT_MS);return tryPromise(timeLimit.left,function(){return _this._base.transCommand(59).then(function(response){if((response&48)!==48){return Promise.reject()}})})}}(this)).then(function(_this){return function(){return _this._base.transCommand(27)}}(this)).then(function(_this){return function(){return _this._base.transCommand(11)}}(this)).then(function(_this){return function(){}}(this))};I2CComm.prototype.stop=function(callback){var timeLimit;if(callback!=null){return invokeCallback(callback,this.stop())}timeLimit=void 0;return Promise.resolve().then(function(_this){return function(){_this._log(1,"stop","(stop condition)");timeLimit=new TimeLimit(I2C_TIMEOUT_MS);return _this._base.transCommand(11)}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._base.transCommand(27).then(function(response){if((response&48)!==16){return Promise.reject()}})})}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._base.transCommand(59).then(function(response){if((response&48)!==48){return Promise.reject()}})})}}(this)).then(function(_this){return function(){if(_this._base.sendImmediate){return}return _this._base.transCommand(57)}}(this)).then(function(_this){return function(){}}(this))};I2CComm.prototype.read=function(ack,callback){var readData,timeLimit;if(callback!=null){return invokeCallback(callback,this.read(ack))}ack=!!ack;timeLimit=void 0;readData=0;return Promise.resolve().then(function(_this){return function(){timeLimit=new TimeLimit(I2C_TIMEOUT_MS);return[7,6,5,4,3,2,1,0].reduce(function(promise,bitNum){return promise.then(function(){return tryPromise(timeLimit.left,function(){return _this._readBit()},1)}).then(function(bit){_this._log(2,"read","bit#"+bitNum+"="+bit);return readData|=bit<<bitNum})},Promise.resolve())}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){_this._log(2,"read",ack?"ACK":"NAK");return _this._writeBit(ack?0:1)},1)}}(this)).then(function(_this){return function(){_this._log(1,"read","data=0x"+readData.toString(16));return readData}}(this))};I2CComm.prototype.write=function(writebyte,callback){var timeLimit;if(callback!=null){return invokeCallback(callback,this.write(writebyte))}writebyte=parseInt(writebyte);timeLimit=void 0;return Promise.resolve().then(function(_this){return function(){_this._log(1,"write","data=0x"+writebyte.toString(16));timeLimit=new TimeLimit(I2C_TIMEOUT_MS);return[7,6,5,4,3,2,1,0].reduce(function(sequence,bitNum){var bit;bit=writebyte>>>bitNum&1;return sequence.then(function(){_this._log(2,"write","bit#"+bitNum+"="+bit);return tryPromise(timeLimit.left,function(){return _this._writeBit(bit)},1)})},Promise.resolve())}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._readBit()},1)}}(this)).then(function(_this){return function(bit){var ack;ack=bit===0;_this._log(2,"write",ack?"ACK":"NAK");return ack}}(this))};I2CComm.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("I2CComm",func,msg,data)}};I2CComm.prototype._readBit=function(){var bit,timeLimit;timeLimit=void 0;bit=0;return Promise.resolve().then(function(_this){return function(){timeLimit=new TimeLimit(I2C_TIMEOUT_MS);_this._log(3,"_readBit","setup,SCL->HiZ");return tryPromise(timeLimit.left,function(){return _this._base.transCommand(59).then(function(response){if((response&16)!==16){return Promise.reject()}if((response&32)===32){return bit=1}})})}}(this)).then(function(_this){return function(){_this._log(3,"_readBit","SCL->L");return _this._base.transCommand(43)}}(this)).then(function(_this){return function(){return bit}}(this))};I2CComm.prototype._writeBit=function(bit){var timeLimit;timeLimit=void 0;bit=(bit!==0?1:0)<<5;return Promise.resolve().then(function(_this){return function(){timeLimit=new TimeLimit(I2C_TIMEOUT_MS);_this._log(3,"_writeBit","setup");return _this._base.transCommand(11|bit)}}(this)).then(function(_this){return function(){_this._log(3,"_writeBit","SCL->HiZ");return tryPromise(timeLimit.left,function(){return _this._base.transCommand(27|bit).then(function(response){if((response&16)!==16){return Promise.reject()}})})}}(this)).then(function(_this){return function(){_this._log(3,"_writeBit","SCL->L");return _this._base.transCommand(43)}}(this)).then(function(_this){return function(){}}(this))};return I2CComm}();Canarium.AvsPackets=function(){null;AvsPackets.property("base",{get:function(){return this._base}});AvsPackets.verbosity=0;function AvsPackets(_base){this._base=_base;return}AvsPackets.prototype.transPacket=function(channel,txdata,rxsize){var byte,dst,eopFinder,header,j,len,len1,pushWithEscape,ref,src,totalRxLen;pushWithEscape=function(array,pos,byte){if(122<=byte&&byte<=125){array[pos++]=125;array[pos++]=byte^32;return pos}array[pos++]=byte;return pos};channel&=255;src=new Uint8Array(txdata);dst=new Uint8Array(txdata.byteLength*2+5);len=0;dst[len++]=124;len=pushWithEscape(dst,len,channel);dst[len++]=122;header=dst.subarray(0,len);ref=src.subarray(0,src.length-1);for(j=0,len1=ref.length;j<len1;j++){byte=ref[j];len=pushWithEscape(dst,len,byte)}dst[len++]=123;len=pushWithEscape(dst,len,src[src.length-1]);txdata=dst.buffer.slice(0,len);totalRxLen=rxsize+header.length+1;this._log(1,"transPacket","begin",{source:src,encoded:new Uint8Array(txdata)});eopFinder=function(_this){return function(rxdata,offset){var array,l,pos,ref1,ref2;array=new Uint8Array(rxdata);for(pos=l=ref1=offset,ref2=array.length;ref1<=ref2?l<ref2:l>ref2;pos=ref1<=ref2?++l:--l){if(array[pos-1]===123&&array[pos-0]!==125||array[pos-2]===123&&array[pos-1]===125){return pos+1}}}}(this);return this._base.transData(txdata,eopFinder).then(function(_this){return function(rxdata){var i,l,len2,m,pos,ref1,xor;src=new Uint8Array(rxdata);_this._log(1,"transPacket","recv",{encoded:src});for(i=l=0,ref1=header.length;0<=ref1?l<ref1:l>ref1;i=0<=ref1?++l:--l){if(src[i]!==header[i]){return Promise.reject(Error("Illegal packetize control bytes"))}}src=src.subarray(header.length);dst=new Uint8Array(rxsize);pos=0;xor=0;for(m=0,len2=src.length;m<len2;m++){byte=src[m];if(pos===rxsize){return Promise.reject(Error("Received data is too large"))}if(byte===123){continue}if(byte===125){xor=32}else{dst[pos++]=byte^xor;xor=0}}if(pos<rxsize){return Promise.reject(Error("Received data is too small"))}_this._log(1,"transPacket","end",{decoded:dst});return dst.buffer}}(this))};AvsPackets.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("AvsPackets",func,msg,data)}};return AvsPackets}();Canarium.AvmTransactions=function(){var AVM_TRANS_MAX_BYTES;null;AvmTransactions.verbosity=0;AVM_TRANS_MAX_BYTES=32768;function AvmTransactions(_avs,_channel){this._avs=_avs;this._channel=_channel;this._lastAction=Promise.resolve();return}AvmTransactions.prototype.read=function(address,bytenum,callback){if(callback!=null){return invokeCallback(callback,this.read(address,bytenum))}return this._avs.base.assertConnection().then(function(_this){return function(){return _this._queue(function(){var dest,x;_this._log(1,"read","begin(address="+hexDump(address)+")");
if(!_this._avs.base.configured){return Promise.reject(Error("Device is not configured"))}dest=new Uint8Array(bytenum);return function(){var j,ref,ref1,results;results=[];for(x=j=0,ref=bytenum,ref1=AVM_TRANS_MAX_BYTES;ref1>0?j<ref:j>ref;x=j+=ref1){results.push(x)}return results}().reduce(function(sequence,pos){return sequence.then(function(){var partialSize;partialSize=Math.min(bytenum-pos,AVM_TRANS_MAX_BYTES);_this._log(2,"read","partial(offset="+hexDump(pos)+",size="+hexDump(partialSize)+")");return _this._trans(20,address+pos,void 0,partialSize).then(function(partialData){return dest.set(new Uint8Array(partialData),pos)})})},Promise.resolve()).then(function(){_this._log(1,"read","end",dest);return dest.buffer})})}}(this))};AvmTransactions.prototype.write=function(address,writedata,callback){var src;if(callback!=null){return invokeCallback(callback,this.write(address,writedata))}src=new Uint8Array(writedata.slice(0));return this._avs.base.assertConnection().then(function(_this){return function(){return _this._queue(function(){var x;_this._log(1,"write","begin(address="+hexDump(address)+")",src);if(!_this._avs.base.configured){return Promise.reject(Error("Device is not configured"))}return function(){var j,ref,ref1,results;results=[];for(x=j=0,ref=src.byteLength,ref1=AVM_TRANS_MAX_BYTES;ref1>0?j<ref:j>ref;x=j+=ref1){results.push(x)}return results}().reduce(function(sequence,pos){return sequence.then(function(){var partialData;partialData=src.subarray(pos,pos+AVM_TRANS_MAX_BYTES);_this._log(2,"write","partial(offset="+hexDump(pos)+")",partialData);return _this._trans(4,address+pos,partialData,void 0)})},Promise.resolve()).then(function(){_this._log(1,"write","end")})})}}(this))};AvmTransactions.prototype.iord=function(address,offset,callback){if(callback!=null){return invokeCallback(callback,this.iord(address,offset))}return this._avs.base.assertConnection().then(function(_this){return function(){return _this._queue(function(){_this._log(1,"iord","begin(address="+hexDump(address)+"+"+offset+")");if(!_this._avs.base.configured){return Promise.reject(Error("Device is not configured"))}return _this._trans(16,(address&4294967292)+(offset<<2),void 0,4).then(function(rxdata){var readData,src;src=new Uint8Array(rxdata);readData=src[3]<<24|src[2]<<16|src[1]<<8|src[0]<<0;_this._log(1,"iord","end",readData);return readData})})}}(this))};AvmTransactions.prototype.iowr=function(address,offset,writedata,callback){if(callback!=null){return invokeCallback(callback,this.iowr(address,offset,writedata))}return this._avs.base.assertConnection().then(function(_this){return function(){return _this._queue(function(){var src;_this._log(1,"iowr","begin(address="+hexDump(address)+"+"+offset+")",writedata);if(!_this._avs.base.configured){return Promise.reject(Error("Device is not configured"))}src=new Uint8Array(4);src[0]=writedata>>>0&255;src[1]=writedata>>>8&255;src[2]=writedata>>>16&255;src[3]=writedata>>>24&255;return _this._trans(0,(address&4294967292)+(offset<<2),src,void 0).then(function(){_this._log(1,"iowr","end")})})}}(this))};AvmTransactions.prototype.option=function(option,callback){if(callback!=null){return invokeCallback(callback,this.option(option))}return this._avs.base.assertConnection().then(function(_this){return function(){return _this._queue(function(){return _this._avs.base.option(option)})}}(this))};AvmTransactions.prototype._queue=function(action){return new Promise(function(_this){return function(resolve,reject){return _this._lastAction=_this._lastAction.then(action).then(resolve,reject)}}(this))};AvmTransactions.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("AvmTransactions",func,msg,data)}};AvmTransactions.prototype._trans=function(transCode,address,txdata,rxsize){var len,pkt;len=(txdata!=null?txdata.byteLength:void 0)||rxsize;pkt=new Uint8Array(8+((txdata!=null?txdata.byteLength:void 0)||0));pkt[0]=transCode;pkt[1]=0;pkt[2]=len>>>8&255;pkt[3]=len>>>0&255;pkt[4]=address>>>24&255;pkt[5]=address>>>16&255;pkt[6]=address>>>8&255;pkt[7]=address>>>0&255;if(txdata){pkt.set(txdata,8)}this._log(2,"_trans","send",pkt);return this._avs.transPacket(this._channel,pkt.buffer,rxsize||4).then(function(_this){return function(rxdata){var res;_this._log(2,"_trans","recv",new Uint8Array(rxdata));if(rxsize){if(rxdata.byteLength!==rxsize){return Promise.reject(Error("Received data length does not match"))}return rxdata}res=new Uint8Array(rxdata);if(!(res[0]===pkt[0]^128&&res[2]===pkt[2]&&res[3]===pkt[3])){return Promise.reject(Error("Illegal write response"))}}}(this))};return AvmTransactions}();if(oldProperty!=null){Function.prototype.property=oldProperty}else{delete Function.prototype.property}this.Canarium=Canarium}).call(this);